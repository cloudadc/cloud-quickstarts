= VPC
:toc: manual

== default network

=== network

[source, bash]
----
gcloud compute networks list
----

link:default.json[default.json]

[source, json]
----
{
    "autoCreateSubnetworks": true,
    "kind": "compute#network",
    "name": "default",
    "networkFirewallPolicyEnforcementOrder": "AFTER_CLASSIC_FIREWALL",
    "x_gcloud_bgp_routing_mode": "REGIONAL",
    "x_gcloud_subnet_mode": "AUTO"
}
----

=== subnets

[source, bash]
----
gcloud compute networks subnets list
----

link:default-subnets.json[default-subnets.json]

|===
|gatewayAddress |ipCidrRange |name |privateIpGoogleAccess |purpose |stackType |network |region

| 10.128.0.1
| 10.128.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| us-central1

| 10.132.0.1
| 10.132.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| europe-west1

| 10.138.0.1
| 10.138.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| us-west1

| 10.140.0.1
| 10.140.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| asia-east1

| 10.142.0.1
| 10.142.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| us-east1

| 10.146.0.1
| 10.146.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| asia-northeast1

| 10.148.0.1
| 10.148.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| asia-southeast1

| 10.150.0.1
| 10.150.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| us-east4

| 10.152.0.1
| 10.152.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| australia-southeast1

| 10.154.0.1
| 10.154.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| europe-west2

| 10.156.0.1
| 10.156.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| europe-west3

| 10.160.0.1
| 10.160.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| asia-south1

| 10.164.0.1
| 10.164.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| europe-west4

| 10.166.0.1
| 10.166.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| europe-north1

| 10.168.0.1
| 10.168.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| us-west2

| 10.180.0.1
| 10.180.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| us-west3

| 10.182.0.1
| 10.182.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| us-west4

| 10.186.0.1
| 10.186.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| europe-central2

| 10.194.0.1
| 10.194.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| southamerica-west1

| 10.196.0.1
| 10.196.0.0/20
| default
| false
| PRIVATE
| IPV4_ONLY
| default
| us-east7

|10.202.0.1
|10.202.0.0/20
|default
|false
|PRIVATE
|IPV4_ONLY
|default
|us-east5

|10.206.0.1
|10.206.0.0/20
|default
|false
|PRIVATE
|IPV4_ONLY
|default
|us-south1

|10.208.0.1
|10.208.0.0/20
|default
|false
|PRIVATE
|IPV4_ONLY
|default
|me-west1
|===

=== routes

[source, bash]
----
gcloud compute routes list
----

link:default-routes.json[default-routes.json]

|===
|destRange |name |priority |network |nextHopNetwork

|0.0.0.0/0
|default-route-a9424e017df6cc72
|1000
|default
|

|10.154.0.0/20
|default-route-120b0e8e1a1e6600
|0
|default
|default

|10.160.0.0/20
|default-route-185361fb8189dc54
|0
|default
|default

|10.132.0.0/20
|default-route-1920fc2005167826
|0
|default
|default

|10.194.0.0/20
|default-route-263f56c558e23588
|0
|default
|default

|10.202.0.0/20
|default-route-2ac9262d4c41487b
|0
|default
|default

|10.140.0.0/20
|default-route-3589d5e6cf6657b9
|0
|default
|default

|10.138.0.0/20
|default-route-3999302cbd084b50
|0
|default
|default

|10.164.0.0/20
|default-route-468313b5bf1066c2
|0
|default
|default

|10.150.0.0/20
|default-route-561bda1e08a32613
|0
|default
|default

|10.128.0.0/20
|default-route-632dca7cafdb3528
|0
|default
|default

|10.186.0.0/20
|default-route-7897f5199529c84b
|0
|default
|default

|10.182.0.0/20
|default-route-817fc4d84c6484bc
|0
|default
|default

|10.146.0.0/20
|default-route-85e8c45f9ba3ad71
|0
|default
|default

|10.180.0.0/20
|default-route-8a1b6b72c04e1c19
|0
|default
|default

|10.142.0.0/20
|default-route-b9ecc55c1f8a18e0
|0
|default
|default

|10.148.0.0/20
|default-route-c0920f75992bc86b
|0
|default
|default

|10.152.0.0/20
|default-route-c316d6acc7332b4b
|0
|default
|default

|10.166.0.0/20
|default-route-d431f58d6523f27a
|0
|default
|default

|10.206.0.0/20
|default-route-d62ba1b5651c11e7
|0
|default
|default


|10.208.0.0/20
|default-route-d66d5f3c08efee80
|0
|default
|default


|10.168.0.0/20
|default-route-e7174b8619696a58
|0
|default
|default

|10.156.0.0/20
|default-route-eccb105ce62524b8
|0
|default
|default

|10.196.0.0/20
|default-route-eebfbfdb149fa172
|0
|default
|default
|===

=== firewall rules

[source, bash] 
----
gcloud compute firewall-rules list
----

link:default-firewall-rules.json[default-firewall-rules.json]

|===
|name |direction |network |priority |sourceRanges |allowedProtocolPort |logConfigEnable
|default-allow-icmp
|INGRESS
|default
|65534
|0.0.0.0/0
|icmp
|false

|default-allow-internal
|INGRESS
|default
|65534
|10.128.0.0/9
|tcp/(0-65535)
|false

|default-allow-rdp
|INGRESS
|default
|65534
|0.0.0.0/0
|tcp/3389
|false

|default-allow-ssh
|INGRESS
|default
|65534
|0.0.0.0/0
|tcp/22
|false
|===


== delete default network

=== delete vpc network firewall rules

[source, bash]
----
for i in $(gcloud compute firewall-rules list | grep NAME | awk '{print $2}') ; do gcloud compute firewall-rules delete $i ; done
----

=== delete default vpc network

[source, bash]
----
gcloud compute networks delete default
----

== One VPC, Three Netowrks, Two Regions, Five VMs

|===
|NAME |Region| ZONE |Network| Internal IP

|mynetwork-us-vm
|us-central1
|us-central1-b
|mynetwork
|10.128.0.2

|mynetwork-eu-vm
|europe-west1
|europe-west1-c
|mynetwork
|10.132.0.2

|managementnet-us-vm
|us-central1
|us-central1-b
|managementnet
|10.240.0.2

|privatenet-us-vm
|us-central1
|us-central1-b
|privatenet
|172.16.0.2

|privatenet-eu-vm
|europe-west1
|europe-west1-c
|privatenet
|172.20.0.2

|===

* link:instances.json[instances.json]

=== Create Networks

[source, bash]
.*delete default network*
----
for i in $(gcloud compute firewall-rules list | grep NAME | awk '{print $2}') ; do gcloud compute firewall-rules delete $i ; done
gcloud compute networks delete default
----

[source, bash]
.*Create networks*
----
gcloud compute networks create mynetwork --subnet-mode=auto
gcloud compute networks create managementnet --subnet-mode=custom
gcloud compute networks create privatenet --subnet-mode=custom
----

[source, bash]
.*Create subnets*
----
gcloud compute networks subnets create managementsubnet-us --network=managementnet --region=us-central1 --range=10.240.0.0/20
gcloud compute networks subnets create privatesubnet-us --network=privatenet --region=us-central1 --range=172.16.0.0/24
gcloud compute networks subnets create privatesubnet-eu --network=privatenet --region=europe-west1 --range=172.20.0.0/20
----

=== Create Firewall Rules

[source, bash]
.*mynetwork*
----
gcloud compute firewall-rules create mynetwork-allow-custom --network=mynetwork --direction=INGRESS --priority=65534 --source-ranges=10.128.0.0/9 --action=ALLOW --rules=all
gcloud compute firewall-rules create mynetwork-allow-icmp --network=mynetwork --direction=INGRESS --priority=65534 --source-ranges=0.0.0.0/0 --action=ALLOW --rules=icmp
gcloud compute firewall-rules create mynetwork-allow-rdp --network=mynetwork --direction=INGRESS --priority=65534 --source-ranges=0.0.0.0/0 --action=ALLOW --rules=tcp:3389
gcloud compute firewall-rules create mynetwork-allow-ssh --network=mynetwork --direction=INGRESS --priority=65534 --source-ranges=0.0.0.0/0 --action=ALLOW --rules=tcp:22
----

[source, bash]
.*managementnet*
----
gcloud compute firewall-rules create managementnet-allow-icmp-ssh-rdp --direction=INGRESS --priority=1000 --network=managementnet --action=ALLOW --rules=icmp,tcp:22,tcp:3389 --source-ranges=0.0.0.0/0
----

[source, bash]
.*privatenet*
----
gcloud compute firewall-rules create privatenet-allow-icmp-ssh-rdp --direction=INGRESS --priority=1000 --network=privatenet --action=ALLOW --rules=icmp,tcp:22,tcp:3389 --source-ranges=0.0.0.0/0
----

=== Create VMs

[source, bash]
.*mynetwork*
----
gcloud compute instances create mynetwork-us-vm --zone=us-central1-b --machine-type=e2-micro --subnet=mynetwork --image-family=debian-11 --image-project=debian-cloud --boot-disk-size=10GB --boot-disk-type=pd-standard --boot-disk-device-name=mynetwork-us-vm
gcloud compute instances create mynetwork-eu-vm --zone=europe-west1-c --machine-type=e2-micro --subnet=mynetwork --image-family=debian-11 --image-project=debian-cloud --boot-disk-size=10GB --boot-disk-type=pd-standard --boot-disk-device-name=mynetwork-eu-vm
----

[source, bash]
.*managementnet*
----
gcloud compute instances create managementnet-us-vm --zone=us-central1-b --machine-type=e2-micro --subnet=managementsubnet-us --image-family=debian-11 --image-project=debian-cloud --boot-disk-size=10GB --boot-disk-type=pd-standard --boot-disk-device-name=managementnet-us-vm
----

[source, bash]
.*privatesubnet*
----
gcloud compute instances create privatenet-us-vm --zone=us-central1-b --machine-type=e2-micro --subnet=privatesubnet-us --image-family=debian-11 --image-project=debian-cloud --boot-disk-size=10GB --boot-disk-type=pd-standard --boot-disk-device-name=privatenet-us-vm
gcloud compute instances create privatenet-eu-vm --zone=europe-west1-c --machine-type=e2-micro --subnet=privatesubnet-eu --image-family=debian-11 --image-project=debian-cloud --boot-disk-size=10GB --boot-disk-type=pd-standard --boot-disk-device-name=privatenet-us-vm
----

=== Test Connectivity

[source, bash]
.*Extract Internal and External IPs*
----
INTERNAL_IPS=$(gcloud compute instances list | grep INTERNAL_IP | awk '{print $2}')
EXTERNAL_IPS=$(gcloud compute instances list | grep EXTERNAL_IP | awk '{print $2}')
echo $INTERNAL_IPS
echo $EXTERNAL_IPS
----

[source, bash]
.*SSH to mynetwork-us-vm, and ping all external ips*
----
mynetwork-us-vm:~$ for i in $EXTERNAL_IPS ; do ping $i -c3 ; done
PING 34.28.96.75 (34.28.96.75) 56(84) bytes of data.
64 bytes from 34.28.96.75: icmp_seq=1 ttl=61 time=2.26 ms
64 bytes from 34.28.96.75: icmp_seq=2 ttl=61 time=0.701 ms
64 bytes from 34.28.96.75: icmp_seq=3 ttl=61 time=0.810 ms

--- 34.28.96.75 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2011ms
rtt min/avg/max/mdev = 0.701/1.257/2.260/0.710 ms
PING 34.122.119.170 (34.122.119.170) 56(84) bytes of data.
64 bytes from 34.122.119.170: icmp_seq=1 ttl=61 time=1.67 ms
64 bytes from 34.122.119.170: icmp_seq=2 ttl=61 time=0.557 ms
64 bytes from 34.122.119.170: icmp_seq=3 ttl=61 time=0.499 ms

--- 34.122.119.170 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2012ms
rtt min/avg/max/mdev = 0.499/0.908/1.668/0.537 ms
PING 34.67.22.140 (34.67.22.140) 56(84) bytes of data.
64 bytes from 34.67.22.140: icmp_seq=1 ttl=61 time=2.75 ms
64 bytes from 34.67.22.140: icmp_seq=2 ttl=61 time=0.657 ms
64 bytes from 34.67.22.140: icmp_seq=3 ttl=61 time=0.653 ms

--- 34.67.22.140 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2012ms
rtt min/avg/max/mdev = 0.653/1.352/2.746/0.985 ms
PING 34.77.219.183 (34.77.219.183) 56(84) bytes of data.
64 bytes from 34.77.219.183: icmp_seq=1 ttl=53 time=104 ms
64 bytes from 34.77.219.183: icmp_seq=2 ttl=53 time=103 ms
64 bytes from 34.77.219.183: icmp_seq=3 ttl=53 time=103 ms

--- 34.77.219.183 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 103.082/103.552/104.420/0.614 ms
PING 35.233.109.131 (35.233.109.131) 56(84) bytes of data.
64 bytes from 35.233.109.131: icmp_seq=1 ttl=53 time=105 ms
64 bytes from 35.233.109.131: icmp_seq=2 ttl=53 time=103 ms
64 bytes from 35.233.109.131: icmp_seq=3 ttl=53 time=103 ms

--- 35.233.109.131 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 103.280/103.802/104.813/0.714 ms
----

[source, bash]
.*SSH to mynetwork-us-vm, and ping all external ips*
----
$ for i in $INTERNAL_IPS ; do ping $i -c3 ; done
PING 10.240.0.2 (10.240.0.2) 56(84) bytes of data.

--- 10.240.0.2 ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 2049ms

PING 10.128.0.2 (10.128.0.2) 56(84) bytes of data.
64 bytes from 10.128.0.2: icmp_seq=1 ttl=64 time=0.027 ms
64 bytes from 10.128.0.2: icmp_seq=2 ttl=64 time=0.051 ms
64 bytes from 10.128.0.2: icmp_seq=3 ttl=64 time=0.050 ms

--- 10.128.0.2 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2029ms
rtt min/avg/max/mdev = 0.027/0.042/0.051/0.011 ms
PING 172.16.0.2 (172.16.0.2) 56(84) bytes of data.

--- 172.16.0.2 ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 2044ms

PING 10.132.0.2 (10.132.0.2) 56(84) bytes of data.
64 bytes from 10.132.0.2: icmp_seq=1 ttl=64 time=104 ms
64 bytes from 10.132.0.2: icmp_seq=2 ttl=64 time=109 ms
64 bytes from 10.132.0.2: icmp_seq=3 ttl=64 time=109 ms

--- 10.132.0.2 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 104.079/107.486/109.197/2.409 ms
PING 172.20.0.2 (172.20.0.2) 56(84) bytes of data.

--- 172.20.0.2 ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 2024ms
----

NOTE: only VM in mynetwork can be ping successfully.


=== Delete VMs, Firewall rules, Networks

[source, bash]
.*Delete VM, Firewall rules, networks*
----
for i in $(gcloud compute instances list | grep NAME | awk '{print $2}'); do gcloud compute instances delete $i --zone=$(gcloud compute instances list $i | grep ZONE | awk '{print $2}'); done

for i in $(gcloud compute firewall-rules list | grep NAME | awk '{print $2}') ; do gcloud compute firewall-rules delete $i ; done

for i in $(gcloud compute networks list | grep NAME | awk '{print $2}'); do gcloud compute networks delete $i ; done
----

== One VPC, One Netowrks, Two Regions, Four VMs 

As below figure, 4 VM instances will created, `vm-1`, `vm-2` and `vm-3` are all on same region, `vm-4` on a different region, `vm-1` and `vm-2` also on same zone, `vm-3` on a different zone, `vm-1`, `vm-2` and `vm-3`.

image:img/gcp-vpc.png[]

=== Create custom Network

Use the following steps to create a custom vpc network:

[source, bash]
.*1. delete default network*
----
for i in $(gcloud compute firewall-rules list | grep NAME | awk '{print $2}') ; do gcloud compute firewall-rules delete $i ; done
gcloud compute networks delete default
----

[source, bash]
.*2. create custom network*
----
gcloud compute networks create mynetwork --subnet-mode=custom --mtu=1460 --bgp-routing-mode=regional
----

[source, bash]
.*3. create subnets*
----
gcloud compute networks subnets create subnet-1 --range=10.140.0.0/20 --stack-type=IPV4_ONLY --network=mynetwork --region=asia-east1
gcloud compute networks subnets create subnet-2 --range=10.146.0.0/20 --stack-type=IPV4_ONLY --network=mynetwork --region=asia-northeast1
----

[source, bash]
.*4. create firewall rules*
----
gcloud compute firewall-rules create mynetwork-allow-custom --network=mynetwork --direction=INGRESS --priority=65534 --source-ranges=10.140.0.0/20,10.146.0.0/20 --action=ALLOW --rules=all
gcloud compute firewall-rules create mynetwork-allow-icmp --network=mynetwork --direction=INGRESS --priority=65534 --source-ranges=0.0.0.0/0 --action=ALLOW --rules=icmp
gcloud compute firewall-rules create mynetwork-allow-rdp --network=mynetwork --direction=INGRESS --priority=65534 --source-ranges=0.0.0.0/0 --action=ALLOW --rules=tcp:3389
gcloud compute firewall-rules create mynetwork-allow-ssh --network=mynetwork --direction=INGRESS --priority=65534 --source-ranges=0.0.0.0/0 --action=ALLOW --rules=tcp:22
----

=== Create VMs

[source, bash]
.*Create 4 vm instances on Cloud Shell*
----
gcloud compute instances create vm-1  --zone=asia-east1-a --machine-type=e2-micro --network-interface=network-tier=PREMIUM,subnet=subnet-1 --metadata=enable-oslogin=true --maintenance-policy=MIGRATE --provisioning-model=STANDARD --create-disk=auto-delete=yes,boot=yes,device-name=vm-1,image=centos-7-v20221206,mode=rw,size=20,type=pd-balanced --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --reservation-affinity=any

gcloud compute instances create vm-2  --zone=asia-east1-a --machine-type=e2-micro --network-interface=network-tier=PREMIUM,subnet=subnet-1 --metadata=enable-oslogin=true --maintenance-policy=MIGRATE --provisioning-model=STANDARD --create-disk=auto-delete=yes,boot=yes,device-name=vm-1,image=centos-7-v20221206,mode=rw,size=20,type=pd-balanced --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --reservation-affinity=any

gcloud compute instances create vm-3  --zone=asia-east1-c --machine-type=e2-micro --network-interface=network-tier=PREMIUM,subnet=subnet-1 --metadata=enable-oslogin=true --maintenance-policy=MIGRATE --provisioning-model=STANDARD --create-disk=auto-delete=yes,boot=yes,device-name=vm-1,image=centos-7-v20221206,mode=rw,size=20,type=pd-balanced --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --reservation-affinity=any

gcloud compute instances create vm-4  --zone=asia-northeast1-b --machine-type=e2-micro --network-interface=network-tier=PREMIUM,subnet=subnet-2 --metadata=enable-oslogin=true --maintenance-policy=MIGRATE --provisioning-model=STANDARD --create-disk=auto-delete=yes,boot=yes,device-name=vm-1,image=centos-7-v20221206,mode=rw,size=20,type=pd-balanced --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --reservation-affinity=any
----

=== test icmp connectivity

[source, bash]
.*1. extract the internal ips and external ips*
----
INTERNAL_IPS=$(gcloud compute instances list | grep INTERNAL_IP | awk '{print $2}')
EXTERNAL_IPS=$(gcloud compute instances list | grep EXTERNAL_IP | awk '{print $2}')
echo $INTERNAL_IPS
echo $EXTERNAL_IPS
----

NOTE: Copy the both output, which will used in next step.

[source, bash]
.*2. set INTERNAL_IPS and EXTERNAL_IPS with value of above outputs, execute the following commands in all vms*
----
for i in $INTERNAL_IPS ; do ping $i -c3 ; done
for i in $EXTERNAL_IPS ; do ping $i -c3 ; done
----

NOTE: All ping on each vms are success, both internal and external ip can be ping succcess on all vms, no matter vm are on same zone, same region, different region, same subnet, different subnet.

=== vpc network performance

In this section, we will test the customized vpc network which created in above step via `ping` and `ttcp` tools. `ttcp` need install on all vms, more about ttcp refer to https://github.com/kylinsoong/ttcp/releases.

Run ttcp recv on `vm-1`, then run ttcp trans on vm-2`, `vm-3` and `vm-4` accordingly, record the results. Raw results from recv side refer to link:results.ttcp[results.ttcp], which each trans are run 3 times.

image:img/gcp-vpc-network-performa.png[]

* vm in same subnet has similar performance, even they are on same zone, or different zone
* vm on different subnet(vm are across region) has significant performance downgrade
* TPS on same subnet are around 116 MB/sec
* TPS on different subnet are around 70 MB/sec

=== remove allow icmp firewall rule, test icmp/tcp connectivity

[source, bash]
.*1. remove allow icmp firewall rule*
----
gcloud compute firewall-rules delete mynetwork-allow-icmp
----

[source, bash]
.*2. test icmp connectivity*
----
for i in $INTERNAL_IPS ; do ping $i -c3 ; done
for i in $EXTERNAL_IPS ; do ping $i -c3 ; done
----

NOTE: The ping against internal ips are all success, even vm are across different region and different subnets; all ping against external ips all failed, which remove allow icmp firewall rule take effect.

[source, bash]
.*3. test tcp connectivity*
----
@vm-4 ~]$ ttcp -t 10.140.0.2
@vm-3 ~]$ ttcp -t 10.140.0.2
@vm-2 ~]$ ttcp -t 10.140.0.2
----

NOTE: All ttcp trans from `vm-2`, `vm-3`, `vm-4` are transmit data to `vm-1` are success.

=== remove allow internal rule, test icmp/tcp connectivity

[source, bash]
.*1. remove allow internal firewall rule*
----
gcloud compute firewall-rules delete mynetwork-allow-custom
----

[source, bash]
.*2. test icmp connectivity*
----
for i in $INTERNAL_IPS ; do ping $i -c3 ; done
----

NOTE: Ping internal ips all failed, tcmp were forbidden.

[source, bash]
.*3. test tcp connectivity*
----
@vm-4 ~]$ ttcp -t 10.140.0.2
@vm-3 ~]$ ttcp -t 10.140.0.2
@vm-2 ~]$ ttcp -t 10.140.0.2
----

NOTE: All ttcp trans execute failed, tcp were forbidden.

== VM Connectivity

=== Create Custom Network

[source, bash]
----
gcloud compute networks create privatenet --subnet-mode=custom

gcloud compute networks subnets create privatenet-us --network=privatenet --region=us-central1 --range=10.130.0.0/20

gcloud compute firewall-rules create privatenet-allow-ssh --network=privatenet --direction=INGRESS --priority=65534 --source-ranges=0.0.0.0/0 --action=ALLOW --rules=tcp:22
----

=== Create VM instance with no public IP address

[source, bash]
.*Create VM instance*
----
gcloud compute instances create vm-internal --zone=us-central1-c --machine-type=n1-standard-1 --network-interface=subnet=privatenet-us,no-address --image-family=debian-11 --image-project=debian-cloud --boot-disk-size=10GB --boot-disk-type=pd-standard --boot-disk-device-name=vm-internal
----

=== `ssh` to connect to vm-internal in GCP Console

.*Client the SSH to connect with SSH on GCP Console VM instances list*

The SSH to vm-internal is success, which hints the VM instance with no public IP address can be accessed via SSH in GCP Console VM instances list

[source, bash]
.*Show assigned internal IP address of vm-internal*
----
$ ip addr show ens4:
2: ens4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1460 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 42:01:0a:82:00:02 brd ff:ff:ff:ff:ff:ff
    altname enp0s4
    inet 10.130.0.2/32 brd 10.130.0.2 scope global dynamic ens4
       valid_lft 3179sec preferred_lft 3179sec
    inet6 fe80::4001:aff:fe82:2/64 scope link 
       valid_lft forever preferred_lft forever
----

* Detailed about vm-internal: link:vm-internal-no-public-ip.json[vm-internal-no-public-ip.json]

=== `gcloud compute ssh` to connect to vm-internal using an Identity-Aware Proxy (IAP) tunnel

[source, bash]
----
gcloud compute ssh vm-internal --zone us-central1-c --tunnel-through-iap
----

NOTE: `gcloud compute ssh` will generate certificates to enable no password input ssh.

=== Download Cloud Storage figure in vm-internal

[source, bash]
.*Create a bucket, copy a figure to bucket*
----
gsutil mb gs://kylintest
gsutil cp gs://cloud-training/gcpnet/private/access.svg gs://kylintest
----

[source, bash]
.*SSH to vm-internal, try to download figure to local*
----
$ gcloud compute ssh vm-internal --zone us-central1-c --tunnel-through-iap
...
@vm-internal:~$ gsutil cp gs://kylintest/*.svg .
INFO 0102 15:37:15.013244 retry_util.py] Retrying request, attempt #1...
----

NOTE: The vm-internal can not download the figure from bucket to local without public IP address assigned.

=== Enable Private Google Access on subnet

[source, bash]
.*Enable Private Google Access*
----
gcloud compute networks subnets update privatenet-us --region=us-central1 --enable-private-ip-google-access
----

[source, bash]
.*SSH to vm-internal, try to download figure to local*
----
vm-internal:~$ gsutil cp gs://kylintest/*.svg .
Copying gs://kylintest/access.svg...
/ [1 files][ 24.8 KiB/ 24.8 KiB]
Operation completed over 1 objects/24.8 KiB.

vm-internal:~$ ls -l *.svg
-rw-r--r-- 1 student-01-0b2ebb62bede google-sudoers 25350 Jan  2 15:47 access.svg
----

NOTE: The `gsutil cp` execute successful, can download the figure from Google Cloud Storage.

=== Configure a Cloud NAT gateway

[source, bash]
.*SSH to vm-internal, install dnsutils package*
----
vm-internal:~$ sudo apt install dnsutils
...
0% [Connecting to deb.debian.org (146.75.78.132)] [Connecting to security.debian.org (151.101.66.132)]   
----

NOTE: The package install stuck in connecting to internet repository, and finally failed, because vm-internal only has access to Google APIs and services.

*Create Cloud NAT gateway from Network services > Cloud NAT*

NOTE: The Cloud NAT should reference a Cloud Router and a VPC Network.

[source, bash]
.*SSH to vm-internal, install dnsutils package*
----
vm-internal:~$ sudo apt install dnsutils
...
Progress: [ 98%] [########################################################################################################################################################################################.....]
----

NOTE: The package installed successfully due to the Cloud NAT gateway be set up.

=== VM instance DNS Mapping

SSH to vm-internal to implement DNS Lookup

[source, bash]
.*A*
----
$ nslookup -type=A vm-internal
Server:         169.254.169.254
Address:        169.254.169.254#53

Non-authoritative answer:
Name:   vm-internal.us-central1-c.c.qwiklabs-gcp-00-107214e97e2f.internal
Address: 10.130.0.2
----

[source, bash]
.*A*
----
$ nslookup -type=A  vm-internal.us-central1-c.c.qwiklabs-gcp-00-107214e97e2f.internal
Server:         169.254.169.254
Address:        169.254.169.254#53

Non-authoritative answer:
Name:   vm-internal.us-central1-c.c.qwiklabs-gcp-00-107214e97e2f.internal
Address: 10.130.0.2
----

[source, bash]
.*PTR*
----
$ nslookup -type=PTR 10.130.0.2
Server:         169.254.169.254
Address:        169.254.169.254#53

Non-authoritative answer:
2.0.130.10.in-addr.arpa name = vm-internal.us-central1-c.c.qwiklabs-gcp-00-107214e97e2f.internal.
----

[source, bash]
.*SOA*
----
$ nslookup -type=SOA vm-internal.us-central1-c.c.qwiklabs-gcp-00-107214e97e2f.internal
Server:         169.254.169.254
Address:        169.254.169.254#53

Non-authoritative answer:
*** Can't find vm-internal.us-central1-c.c.qwiklabs-gcp-00-107214e97e2f.internal: No answer

Authoritative answers can be found from:
internal
        origin = ns.us-central1.gcedns-prod.internal
        mail addr = cloud-dns-hostmaster.google.com
        serial = 2015030600
        refresh = 7200
        retry = 3600
        expire = 24796800
        minimum = 5
----

== VM instance with multiple network interfaces

[source, bash]
.*Create Instances*
----
gcloud compute instances create vm-appliance --zone=us-central1-c --machine-type=n1-standard-4 --network-interface=network-tier=PREMIUM,subnet=privatesubnet-us --network-interface=network-tier=PREMIUM,subnet=managementsubnet-us --network-interface=network-tier=PREMIUM,subnet=mynetwork --metadata=enable-oslogin=true --maintenance-policy=MIGRATE --provisioning-model=STANDARD --create-disk=auto-delete=yes,boot=yes,device-name=vm-appliance,image=projects/debian-cloud/global/images/debian-11-bullseye-v20221206,mode=rw,size=10,type=pd-balanced --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --reservation-affinity=any
----

[source, bash]
.*Verify network interfaces*
----
$ sudo ifconfig
ens4: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1460
        inet 172.16.0.3  netmask 255.255.255.255  broadcast 172.16.0.3
        inet6 fe80::4001:acff:fe10:3  prefixlen 64  scopeid 0x20<link>
        ether 42:01:ac:10:00:03  txqueuelen 1000  (Ethernet)
        RX packets 508  bytes 124182 (121.2 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 460  bytes 51961 (50.7 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

ens5: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1460
        inet 10.130.0.3  netmask 255.255.255.255  broadcast 10.130.0.3
        inet6 fe80::4001:aff:fe82:3  prefixlen 64  scopeid 0x20<link>
        ether 42:01:0a:82:00:03  txqueuelen 1000  (Ethernet)
        RX packets 5  bytes 2362 (2.3 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 15  bytes 2234 (2.1 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

ens6: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1460
        inet 10.128.0.3  netmask 255.255.255.255  broadcast 10.128.0.3
        inet6 fe80::4001:aff:fe80:3  prefixlen 64  scopeid 0x20<link>
        ether 42:01:0a:80:00:03  txqueuelen 1000  (Ethernet)
        RX packets 5  bytes 2374 (2.3 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 15  bytes 2234 (2.1 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 36  bytes 3060 (2.9 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 36  bytes 3060 (2.9 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
----

[source, bash]
.*Route Tables*
----
$ ip route
default via 172.16.0.1 dev ens4 
10.128.0.0/20 via 10.128.0.1 dev ens6 
10.128.0.1 dev ens6 scope link 
10.130.0.0/20 via 10.130.0.1 dev ens5 
10.130.0.1 dev ens5 scope link 
172.16.0.0/24 via 172.16.0.1 dev ens4 
172.16.0.1 dev ens4 scope link 
----

== Custom Mode VPC Network

=== create subnet

[source, bash]
.*Create VPC*
----
gcloud compute networks create custom-network --subnet-mode=custom
----

[source, bash]
.*Create Subnet A*
----
gcloud compute networks subnets create subnet-a --network=custom-network --region=us-central1 --range=10.0.1.0/24
----

[source, bash]
.*Create Subnet B*
----
gcloud compute networks subnets create subnet-b --network=custom-network --region=europe-west1 --range=10.0.2.0/24
---- 

[source, bash]
.*View the network*
----
$ gcloud compute networks list --format=yaml
---
autoCreateSubnetworks: false
creationTimestamp: '2023-02-11T16:39:10.886-08:00'
id: '8956849635478309825'
kind: compute#network
name: custom-network
networkFirewallPolicyEnforcementOrder: AFTER_CLASSIC_FIREWALL
routingConfig:
  routingMode: REGIONAL
selfLink: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/global/networks/custom-network
selfLinkWithId: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/global/networks/8956849635478309825
subnetworks:
- https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/regions/europe-west1/subnetworks/subnet-b
- https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/regions/us-central1/subnetworks/subnet-a
x_gcloud_bgp_routing_mode: REGIONAL
x_gcloud_subnet_mode: CUSTOM
----

[source, bash]
.*View the subnets*
----
$ gcloud compute networks subnets list --network=custom-network --format=yaml
---
creationTimestamp: '2023-02-11T16:41:54.891-08:00'
fingerprint: 0hsKms7xsk4=
gatewayAddress: 10.0.1.1
id: '4111491110948670269'
ipCidrRange: 10.0.1.0/24
kind: compute#subnetwork
name: subnet-a
network: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/global/networks/custom-network
privateIpGoogleAccess: false
privateIpv6GoogleAccess: DISABLE_GOOGLE_ACCESS
purpose: PRIVATE
region: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/regions/us-central1
selfLink: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/regions/us-central1/subnetworks/subnet-a
stackType: IPV4_ONLY
---
creationTimestamp: '2023-02-11T16:43:32.888-08:00'
fingerprint: qNGQcOdB0p0=
gatewayAddress: 10.0.2.1
id: '808864107335092443'
ipCidrRange: 10.0.2.0/24
kind: compute#subnetwork
name: subnet-b
network: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/global/networks/custom-network
privateIpGoogleAccess: false
privateIpv6GoogleAccess: DISABLE_GOOGLE_ACCESS
purpose: PRIVATE
region: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/regions/europe-west1
selfLink: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/regions/europe-west1/subnetworks/subnet-b
stackType: IPV4_ONLY
----

=== create firewall

[source, bash]
.*Create Firewall*
----
gcloud compute firewall-rules create allow-ssh-icmp --allow=tcp:22,icmp --network=custom-network
----

[source, bash]
.*View firewall*
----
$ gcloud compute firewall-rules list --format=yaml
---
allowed:
- IPProtocol: tcp
  ports:
  - '22'
- IPProtocol: icmp
creationTimestamp: '2023-02-11T16:50:45.520-08:00'
description: ''
direction: INGRESS
disabled: false
id: '1249548788654508298'
kind: compute#firewall
logConfig:
  enable: false
name: allow-ssh-icmp
network: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/global/networks/custom-network
priority: 1000
selfLink: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/global/firewalls/allow-ssh-icmp
sourceRanges:
- 0.0.0.0/0
----

=== Create VMs

[source, bash]
.*Create VM instance to use the network*
----
gcloud compute instances create vm-us --subnet=subnet-a --zone=us-central1-a
gcloud compute instances create vm-eu --subnet=subnet-b --zone=europe-west1-b
----

[source, bash]
.*View vm-us*
----
canIpForward: false
cpuPlatform: Intel Haswell
creationTimestamp: '2023-02-11T16:54:37.110-08:00'
deletionProtection: false
disks:
- architecture: X86_64
  autoDelete: true
  boot: true
  deviceName: persistent-disk-0
  diskSizeGb: '10'
  guestOsFeatures:
  - type: UEFI_COMPATIBLE
  - type: VIRTIO_SCSI_MULTIQUEUE
  - type: GVNIC
  index: 0
  interface: SCSI
  kind: compute#attachedDisk
  licenses:
  - https://www.googleapis.com/compute/v1/projects/debian-cloud/global/licenses/debian-11-bullseye
  mode: READ_WRITE
  source: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/zones/us-central1-a/disks/vm-us
  type: PERSISTENT
fingerprint: gfkXkOBotgI=
id: '8499902172161738276'
kind: compute#instance
labelFingerprint: 42WmSpB8rSM=
lastStartTimestamp: '2023-02-11T16:54:46.291-08:00'
machineType: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/zones/us-central1-a/machineTypes/n1-standard-1
metadata:
  fingerprint: tRj5tDQxPH8=
  kind: compute#metadata
name: vm-us
networkInterfaces:
- accessConfigs:
  - kind: compute#accessConfig
    name: external-nat
    natIP: 34.68.58.85
    networkTier: PREMIUM
    type: ONE_TO_ONE_NAT
  fingerprint: gO06wFOR1ZU=
  kind: compute#networkInterface
  name: nic0
  network: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/global/networks/custom-network
  networkIP: 10.0.1.2
  stackType: IPV4_ONLY
  subnetwork: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/regions/us-central1/subnetworks/subnet-a
scheduling:
  automaticRestart: true
  onHostMaintenance: MIGRATE
  preemptible: false
  provisioningModel: STANDARD
selfLink: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/zones/us-central1-a/instances/vm-us
serviceAccounts:
- email: 892646637332-compute@developer.gserviceaccount.com
  scopes:
  - https://www.googleapis.com/auth/devstorage.read_only
  - https://www.googleapis.com/auth/logging.write
  - https://www.googleapis.com/auth/monitoring.write
  - https://www.googleapis.com/auth/pubsub
  - https://www.googleapis.com/auth/service.management.readonly
  - https://www.googleapis.com/auth/servicecontrol
  - https://www.googleapis.com/auth/trace.append
shieldedInstanceConfig:
  enableIntegrityMonitoring: true
  enableSecureBoot: false
  enableVtpm: true
shieldedInstanceIntegrityPolicy:
  updateAutoLearnPolicy: true
startRestricted: false
status: RUNNING
tags:
  fingerprint: 42WmSpB8rSM=
zone: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/zones/us-central1-a
----

[source, bash]
.*View vm-eu*
----
canIpForward: false
cpuPlatform: Intel Haswell
creationTimestamp: '2023-02-11T16:55:42.618-08:00'
deletionProtection: false
disks:
- architecture: X86_64
  autoDelete: true
  boot: true
  deviceName: persistent-disk-0
  diskSizeGb: '10'
  guestOsFeatures:
  - type: UEFI_COMPATIBLE
  - type: VIRTIO_SCSI_MULTIQUEUE
  - type: GVNIC
  index: 0
  interface: SCSI
  kind: compute#attachedDisk
  licenses:
  - https://www.googleapis.com/compute/v1/projects/debian-cloud/global/licenses/debian-11-bullseye
  mode: READ_WRITE
  source: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/zones/europe-west1-b/disks/vm-eu
  type: PERSISTENT
fingerprint: HN8IB7b9mok=
id: '206073706563602403'
kind: compute#instance
labelFingerprint: 42WmSpB8rSM=
lastStartTimestamp: '2023-02-11T16:55:46.866-08:00'
machineType: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/zones/europe-west1-b/machineTypes/n1-standard-1
metadata:
  fingerprint: tRj5tDQxPH8=
  kind: compute#metadata
name: vm-eu
networkInterfaces:
- accessConfigs:
  - kind: compute#accessConfig
    name: external-nat
    natIP: 34.77.138.124
    networkTier: PREMIUM
    type: ONE_TO_ONE_NAT
  fingerprint: rtfX-f08OjQ=
  kind: compute#networkInterface
  name: nic0
  network: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/global/networks/custom-network
  networkIP: 10.0.2.2
  stackType: IPV4_ONLY
  subnetwork: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/regions/europe-west1/subnetworks/subnet-b
scheduling:
  automaticRestart: true
  onHostMaintenance: MIGRATE
  preemptible: false
  provisioningModel: STANDARD
selfLink: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/zones/europe-west1-b/instances/vm-eu
serviceAccounts:
- email: 892646637332-compute@developer.gserviceaccount.com
  scopes:
  - https://www.googleapis.com/auth/devstorage.read_only
  - https://www.googleapis.com/auth/logging.write
  - https://www.googleapis.com/auth/monitoring.write
  - https://www.googleapis.com/auth/pubsub
  - https://www.googleapis.com/auth/service.management.readonly
  - https://www.googleapis.com/auth/servicecontrol
  - https://www.googleapis.com/auth/trace.append
shieldedInstanceConfig:
  enableIntegrityMonitoring: true
  enableSecureBoot: false
  enableVtpm: true
shieldedInstanceIntegrityPolicy:
  updateAutoLearnPolicy: true
startRestricted: false
status: RUNNING
tags:
  fingerprint: 42WmSpB8rSM=
zone: https://www.googleapis.com/compute/v1/projects/build-a-cust-83-4aabe271/zones/europe-west1-b
----

== Control Firewall Rules

=== View the vm instances

* link:firewall-rules-instances.yaml[firewall-rules-instances.yaml]

|===
|name |zone |network |subnet |private ip |public ip |tag

|instance-1a
|us-central1-a
|custom-vpc
|subnet-a
|10.0.1.3
|34.67.108.122
|

|instance-1b
|us-central1-a
|custom-vpc
|subnet-a
|10.0.1.2
|35.184.12.171
|

|instance-3
|us-west1-b
|custom-vpc
|subnet-c
|10.0.3.2
|35.230.105.197
|allow-icmp

|instance-2
|us-east1-c
|custom-vpc
|subnet-b
|10.0.2.2
|35.227.111.0
|allow-icmp
|===

=== Allow SSH

[source, bash]
.*Try SSH before creating firewall rule*
----
Connection Failed
We are unable to connect to the VM on port 22.

Please ensure that VM has a firewall rule that allows TCP ingress traffic from the IP range 0.0.0.0/0, port: 22.
In case you prefer to allow SSH connections for the narrower IP range, please consider using Identity-Aware-Proxy (IAP).
----

[source, bash]
.*Create firewall rule*
----
gcloud compute firewall-rules create allow-ssh --direction=INGRESS --priority=1000 --network=custom-vpc --action=ALLOW --rules=tcp:22 --source-ranges=0.0.0.0/0
----

=== Allow ICMP

[source, bash]
.*Ping instance-3 before creating firewall rule*
----
$ ping 34.67.108.122 -c3
PING 34.67.108.122 (34.67.108.122) 56(84) bytes of data.

--- 34.67.108.122 ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 29ms
----

[source, bash]
.*Create firewall*
----
gcloud compute firewall-rules create allow-icmp --direction=INGRESS --priority=1000 --network=custom-vpc --action=ALLOW --rules=icmp --source-ranges=10.0.1.0/24 --target-tags=allow-icmp
----

[source, bash]
.*Ping instance-2*
----
$ ping 10.0.2.2 -c3
PING 10.0.2.2 (10.0.2.2) 56(84) bytes of data.
64 bytes from 10.0.2.2: icmp_seq=1 ttl=64 time=31.7 ms
64 bytes from 10.0.2.2: icmp_seq=2 ttl=64 time=31.8 ms
64 bytes from 10.0.2.2: icmp_seq=3 ttl=64 time=31.8 ms

--- 10.0.2.2 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 6ms
rtt min/avg/max/mdev = 31.734/31.803/31.841/0.153 ms
----

[source, bash]
.*Ping instance-3*
----
$ ping 10.0.3.2 -c3
PING 10.0.3.2 (10.0.3.2) 56(84) bytes of data.
64 bytes from 10.0.3.2: icmp_seq=1 ttl=64 time=33.1 ms
64 bytes from 10.0.3.2: icmp_seq=2 ttl=64 time=31.9 ms
64 bytes from 10.0.3.2: icmp_seq=3 ttl=64 time=31.9 ms

--- 10.0.3.2 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 4ms
rtt min/avg/max/mdev = 31.890/32.292/33.088/0.599 ms
----

== Firewall with target tag

[source, bash]
----
gcloud compute firewall-rules create allow-http-web-server --direction=INGRESS --priority=1000 --network=default --action=ALLOW --rules=tcp:80 --source-ranges=0.0.0.0/0 --target-tags=web-server
----

== VPC network peering

=== VPC network topology

|===
|ID |Network |Subnet |ipCidr |gatewayAddress |Region

|1
|mynetwork
|mynetwork-us
|10.128.0.0/20
|10.128.0.1
|us-central1

|2
|mynetwork
|mynetwork-eu
|10.132.0.0/20
|10.132.0.1
|europe-west1

|3
|privatenet
|privatesubnet-us
|172.16.0.0/24
|172.16.0.1
|us-central1

|===

[source, bash]
----
$ gcloud compute networks subnets list --format=yaml
----

* link:vpc-peering-network-topologies.yaml[vpc-peering-network-topologies.yaml]

=== Default Route

|===
|Name |Network |destRange |nextHopGateway |nextHopNetwork |priority

|default-route-4a55ed61d9a3ae8d
|privatenet
|0.0.0.0/0
|default-internet-gateway
|
|1000

|default-route-4c8396d18527806f
|privatenet
|172.16.0.0/24
|
|privatenet
|0

|default-route-91ceadd541d6caf8
|mynetwork
|0.0.0.0/0
|default-internet-gateway
|
|1000

|default-route-9e6b63a719576f3e
|mynetwork
|10.132.0.0/20
|
|mynetwork
|0

|default-route-d70b14d081c298ff
|mynetwork
|10.128.0.0/20
|
|mynetwork
|0
|===

[source, bash]
----
$ gcloud compute routes list --format=yaml
----

* link:vpc-peering-network-routes.yaml[vpc-peering-network-routes.yaml]

=== Create VPC Network Peering

[source, bash]
----
gcloud compute networks peerings create peering-1-2 --network=mynetwork --peer-network=privatenet
gcloud compute networks peerings create peering-2-1 --network=privatenet --peer-network=mynetwork
----

[source, bash]
.*View the Peering*
----
$ gcloud compute networks peerings list --format=yaml
----

* link:vpc-peering-network-peering.yaml[vpc-peering-network-peering.yaml]

=== Verify the Route Added

|===
|Name |Network |destRange |nextHopGateway |nextHopNetwork |nextHopPeering |priority

|default-route-4a55ed61d9a3ae8d
|privatenet
|0.0.0.0/0
|default-internet-gateway
|
|
|1000

|default-route-4c8396d18527806f
|privatenet
|172.16.0.0/24
|
|privatenet
|
|0

|default-route-91ceadd541d6caf8
|mynetwork
|0.0.0.0/0
|default-internet-gateway
|
|
|1000

|default-route-9e6b63a719576f3e
|mynetwork
|10.132.0.0/20
|
|mynetwork
|
|0

|default-route-d70b14d081c298ff
|mynetwork
|10.128.0.0/20
|
|mynetwork
|
|0

|peering-route-1972356771bdd51c
|mynetwork
|172.16.0.0/24
|
|
|peering-1-2
|0

|peering-route-589e28fd6c6c268a
|privatenet
|10.128.0.0/20
|
|
|peering-2-1
|0

|peering-route-883aa00ba0b49d3e
|privatenet
|10.132.0.0/20
|
|
|peering-2-1
|0
|===


[source, bash]
----
$ gcloud compute routes list --format=yaml
----

* link:vpc-peering-network-routes-peering.yaml[vpc-peering-network-routes-peering.yaml]


[source, bash]
----

----

[source, bash]
----

----
