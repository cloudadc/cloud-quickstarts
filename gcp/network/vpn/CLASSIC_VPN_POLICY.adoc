= Policy based Classic VPN
:toc: manual

== Reserve external IP

=== vpc-demo

[source, bash]
.*1. Reserve IP*
----
gcloud compute addresses create vpc-demo-gw-ip --region=us-east1
----

[source, bash]
.*2. View Reserve IP*
----
{
  "address": "34.139.16.101",
  "addressType": "EXTERNAL",
  "creationTimestamp": "2023-05-02T18:30:57.033-07:00",
  "description": "",
  "id": "4447858488378132414",
  "kind": "compute#address",
  "labelFingerprint": "42WmSpB8rSM=",
  "name": "vpc-demo-gw-ip",
  "networkTier": "PREMIUM",
  "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1",
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/addresses/vpc-demo-gw-ip",
  "status": "RESERVED"
}
----

=== on-prem

[source, bash]
.*1. Reserve IP*
----
gcloud compute addresses create on-prem-gw-ip --region=us-central1
----

[source, bash]
.*2. View Reserve IP*
----
{
  "address": "35.226.19.45",
  "addressType": "EXTERNAL",
  "creationTimestamp": "2023-05-02T18:31:05.317-07:00",
  "description": "",
  "id": "9050118900426737590",
  "kind": "compute#address",
  "labelFingerprint": "42WmSpB8rSM=",
  "name": "on-prem-gw-ip",
  "networkTier": "PREMIUM",
  "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1",
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/addresses/on-prem-gw-ip",
  "status": "RESERVED"
}
----

== Setup on `vpc-demo` network

=== Create target vpn gateway

[source, bash]
.*1. Create Target VPN Gateway*
----
gcloud compute target-vpn-gateways create vpc-demo-gw --region=us-east1 --network=vpc-demo
----

[source, json]
.*2. View Target VPN Gateway*
----
{
  "creationTimestamp": "2023-05-02T19:04:56.135-07:00",
  "description": "",
  "id": "8775027787011227559",
  "kind": "compute#targetVpnGateway",
  "labelFingerprint": "42WmSpB8rSM=",
  "name": "vpc-demo-gw",
  "network": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/global/networks/vpc-demo",
  "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1",
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/targetVpnGateways/vpc-demo-gw",
  "status": "READY"
}
----

=== Create forwarding rules

[source, bash]
.*1. Rule for sendig ESP(IPsec) traffic to gateway*
----
gcloud compute forwarding-rules create vpc-demo-gw-rule-esp --region=us-east1 --address=34.139.16.101 --ip-protocol=ESP --target-vpn-gateway=vpc-demo-gw
----

[source, bash]
.*2. Rule for sendig UDP 500 traffic to gateway*
----
gcloud compute forwarding-rules create vpc-demo-gw-rule-udp500 --region=us-east1 --address=34.139.16.101 --ip-protocol=UDP --ports=500 --target-vpn-gateway=vpc-demo-gw
----

[source, bash]
.*3. Rule for sendig UDP 4500 traffic to gateway*
----
gcloud compute forwarding-rules create vpc-demo-gw-rule-udp4500 --region=us-east1 --address=34.139.16.101 --ip-protocol=UDP --ports=4500 --target-vpn-gateway=vpc-demo-gw
----

[source, json]
.*4. View all three rules*
----
[
  {
    "IPAddress": "34.139.16.101",
    "IPProtocol": "ESP",
    "creationTimestamp": "2023-05-02T19:06:06.939-07:00",
    "description": "",
    "fingerprint": "ItYuyA91cqU=",
    "id": "5506841219906174817",
    "kind": "compute#forwardingRule",
    "labelFingerprint": "42WmSpB8rSM=",
    "loadBalancingScheme": "EXTERNAL",
    "name": "vpc-demo-gw-rule-esp",
    "networkTier": "PREMIUM",
    "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1",
    "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/forwardingRules/vpc-demo-gw-rule-esp",
    "target": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/targetVpnGateways/vpc-demo-gw"
  },
  {
    "IPAddress": "34.139.16.101",
    "IPProtocol": "UDP",
    "creationTimestamp": "2023-05-02T19:06:41.276-07:00",
    "description": "",
    "fingerprint": "DWLKXQ_g3qo=",
    "id": "4662866556965650270",
    "kind": "compute#forwardingRule",
    "labelFingerprint": "42WmSpB8rSM=",
    "loadBalancingScheme": "EXTERNAL",
    "name": "vpc-demo-gw-rule-udp4500",
    "networkTier": "PREMIUM",
    "portRange": "4500-4500",
    "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1",
    "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/forwardingRules/vpc-demo-gw-rule-udp4500",
    "target": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/targetVpnGateways/vpc-demo-gw"
  },
  {
    "IPAddress": "34.139.16.101",
    "IPProtocol": "UDP",
    "creationTimestamp": "2023-05-02T19:06:24.956-07:00",
    "description": "",
    "fingerprint": "h6VTi2PgmTE=",
    "id": "7685896906211098447",
    "kind": "compute#forwardingRule",
    "labelFingerprint": "42WmSpB8rSM=",
    "loadBalancingScheme": "EXTERNAL",
    "name": "vpc-demo-gw-rule-udp500",
    "networkTier": "PREMIUM",
    "portRange": "500-500",
    "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1",
    "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/forwardingRules/vpc-demo-gw-rule-udp500",
    "target": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/targetVpnGateways/vpc-demo-gw"
  }
]
----

[source, json]
.*5. View Target VPN Gateway after create rules*
----
{
  "creationTimestamp": "2023-05-02T19:04:56.135-07:00",
  "description": "",
  "forwardingRules": [
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/forwardingRules/vpc-demo-gw-rule-udp500",
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/forwardingRules/vpc-demo-gw-rule-udp4500",
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/forwardingRules/vpc-demo-gw-rule-esp"
  ],
  "id": "8775027787011227559",
  "kind": "compute#targetVpnGateway",
  "labelFingerprint": "42WmSpB8rSM=",
  "name": "vpc-demo-gw",
  "network": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/global/networks/vpc-demo",
  "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1",
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/targetVpnGateways/vpc-demo-gw",
  "status": "READY"
}
----

=== Create VPN tunnels

[source, bash]
.*1. Create VPN Tunnel*
----
gcloud compute vpn-tunnels create vpc-demo-tunnel --region=us-east1 --peer-address=35.226.19.45 --shared-secret=shared_key --ike-version=2 --local-traffic-selector=10.2.1.0/24,10.1.1.0/24 --remote-traffic-selector=192.168.1.0/24 --target-vpn-gateway=vpc-demo-gw
----

[source, json]
.*2. View tunnel*
----
{
  "creationTimestamp": "2023-05-02T19:09:26.146-07:00",
  "description": "",
  "detailedStatus": "Allocating resources. VPN tunnel will start soon.",
  "id": "4107248168553184441",
  "ikeVersion": 2,
  "kind": "compute#vpnTunnel",
  "labelFingerprint": "42WmSpB8rSM=",
  "localTrafficSelector": [
    "10.2.1.0/24",
    "10.1.1.0/24"
  ],
  "name": "vpc-demo-tunnel",
  "peerIp": "35.226.19.45",
  "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1",
  "remoteTrafficSelector": [
    "192.168.1.0/24"
  ],
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/vpnTunnels/vpc-demo-tunnel",
  "sharedSecret": "*************",
  "sharedSecretHash": "Ia4pAN2LTlSgnXNLXPBMVojwjnYn",
  "status": "FIRST_HANDSHAKE",
  "targetVpnGateway": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/targetVpnGateways/vpc-demo-gw"
}
----

[source, json]
.*3. View Target VPN Gateway after create tunnel*
----
{
  "creationTimestamp": "2023-05-02T19:04:56.135-07:00",
  "description": "",
  "forwardingRules": [
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/forwardingRules/vpc-demo-gw-rule-udp500",
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/forwardingRules/vpc-demo-gw-rule-esp",
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/forwardingRules/vpc-demo-gw-rule-udp4500"
  ],
  "id": "8775027787011227559",
  "kind": "compute#targetVpnGateway",
  "labelFingerprint": "42WmSpB8rSM=",
  "name": "vpc-demo-gw",
  "network": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/global/networks/vpc-demo",
  "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1",
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/targetVpnGateways/vpc-demo-gw",
  "status": "READY",
  "tunnels": [
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/vpnTunnels/vpc-demo-tunnel"
  ]
}
----

=== Create Static Route

[source, bash]
.*1. Create Route*
----
gcloud compute routes create vpc-demo-tunnel-route-1 --network=vpc-demo --priority=1000 --destination-range=192.168.1.0/24 --next-hop-vpn-tunnel=vpc-demo-tunnel --next-hop-vpn-tunnel-region=us-east1
----

[source, json]
.*2. View Route*
----
{
  "creationTimestamp": "2023-05-02T19:11:26.929-07:00",
  "description": "",
  "destRange": "192.168.1.0/24",
  "id": "7817126874571373601",
  "kind": "compute#route",
  "name": "vpc-demo-tunnel-route-1",
  "network": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/global/networks/vpc-demo",
  "nextHopVpnTunnel": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/vpnTunnels/vpc-demo-tunnel",
  "priority": 1000,
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/global/routes/vpc-demo-tunnel-route-1"
}
----

== Setup on `on-prem` network

=== Create target vpn gateway

[source, bash]
.*1. Create Target VPN Gateway*
----
gcloud compute target-vpn-gateways create on-prem-gw --region=us-central1 --network=on-prem
----

[source, json]
.*2. View Target VPN Gateway*
----
{
  "creationTimestamp": "2023-05-02T19:20:23.735-07:00",
  "description": "",
  "id": "57958731370756616",
  "kind": "compute#targetVpnGateway",
  "labelFingerprint": "42WmSpB8rSM=",
  "name": "on-prem-gw",
  "network": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/global/networks/on-prem",
  "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1",
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/targetVpnGateways/on-prem-gw",
  "status": "READY"
}
----

=== Create forwarding rules

[source, bash]
.*1. Rule for sendig ESP(IPsec) traffic to gateway*
----
gcloud compute forwarding-rules create on-prem-gw-rule-esp --region=us-central1 --address=35.226.19.45 --ip-protocol=ESP --target-vpn-gateway=on-prem-gw
----

[source, bash]
.*2. Rule for sendig UDP 500 traffic to gateway*
----
gcloud compute forwarding-rules create on-prem-gw-rule-udp500 --region=us-central1 --address=35.226.19.45 --ip-protocol=UDP --ports=500 --target-vpn-gateway=on-prem-gw
----

[source, bash]
.*3. Rule for sendig UDP 4500 traffic to gateway*
----
gcloud compute forwarding-rules create on-prem-gw-rule-udp4500 --region=us-central1 --address=35.226.19.45 --ip-protocol=UDP --ports=4500 --target-vpn-gateway=on-prem-gw
----

[source, json]
.*4. View Target VPN Gateway after create rules*
----
{
  "creationTimestamp": "2023-05-02T19:20:23.735-07:00",
  "description": "",
  "forwardingRules": [
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/forwardingRules/on-prem-gw-rule-esp",
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/forwardingRules/on-prem-gw-rule-udp4500",
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/forwardingRules/on-prem-gw-rule-udp500"
  ],
  "id": "57958731370756616",
  "kind": "compute#targetVpnGateway",
  "labelFingerprint": "42WmSpB8rSM=",
  "name": "on-prem-gw",
  "network": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/global/networks/on-prem",
  "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1",
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/targetVpnGateways/on-prem-gw",
  "status": "READY"
}
----

=== Create VPN tunnels

[source, bash]
.*1. Create VPN Tunnel*
----
gcloud compute vpn-tunnels create on-prem-tunnel --region=us-central1 --peer-address=34.139.16.101 --shared-secret=shared_key --ike-version=2 --local-traffic-selector=192.168.1.0/24 --remote-traffic-selector=10.1.1.0/24,10.2.1.0/24 --target-vpn-gateway=on-prem-gw
----

[source, json]
.*2. View tunnel*
----
{
  "creationTimestamp": "2023-05-02T19:22:26.834-07:00",
  "description": "",
  "detailedStatus": "Tunnel is up and running.",
  "id": "8007397653815786381",
  "ikeVersion": 2,
  "kind": "compute#vpnTunnel",
  "labelFingerprint": "42WmSpB8rSM=",
  "localTrafficSelector": [
    "192.168.1.0/24"
  ],
  "name": "on-prem-tunnel",
  "peerIp": "34.139.16.101",
  "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1",
  "remoteTrafficSelector": [
    "10.1.1.0/24",
    "10.2.1.0/24"
  ],
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/vpnTunnels/on-prem-tunnel",
  "sharedSecret": "*************",
  "sharedSecretHash": "OlUjBQaZA2WpwN_Ho5GhKA5kA-jf",
  "status": "ESTABLISHED",
  "targetVpnGateway": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/targetVpnGateways/on-prem-gw"
}
----

[source, json]
.*3. View Target VPN Gateway after create tunnel*
----
{
  "creationTimestamp": "2023-05-02T19:20:23.735-07:00",
  "description": "",
  "forwardingRules": [
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/forwardingRules/on-prem-gw-rule-esp",
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/forwardingRules/on-prem-gw-rule-udp4500",
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/forwardingRules/on-prem-gw-rule-udp500"
  ],
  "id": "57958731370756616",
  "kind": "compute#targetVpnGateway",
  "labelFingerprint": "42WmSpB8rSM=",
  "name": "on-prem-gw",
  "network": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/global/networks/on-prem",
  "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1",
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/targetVpnGateways/on-prem-gw",
  "status": "READY",
  "tunnels": [
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/vpnTunnels/on-prem-tunnel"
  ]
}
----

=== Create Static Route

[source, bash]
.*1. Create Route*
----
gcloud compute routes create on-prem-tunnel-route-1 --network=on-prem --priority=1000 --destination-range=10.1.1.0/24 --next-hop-vpn-tunnel=on-prem-tunnel --next-hop-vpn-tunnel-region=us-central1
gcloud compute routes create on-prem-tunnel-route-2 --network=on-prem --priority=1000 --destination-range=10.2.1.0/24 --next-hop-vpn-tunnel=on-prem-tunnel --next-hop-vpn-tunnel-region=us-central1
----

[source, json]
.*2. View Route*
----
{
  "creationTimestamp": "2023-05-02T19:24:29.981-07:00",
  "description": "",
  "destRange": "10.1.1.0/24",
  "id": "1683857908812249906",
  "kind": "compute#route",
  "name": "on-prem-tunnel-route-1",
  "network": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/global/networks/on-prem",
  "nextHopVpnTunnel": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/vpnTunnels/on-prem-tunnel",
  "priority": 1000,
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/global/routes/on-prem-tunnel-route-1"
}
----

[source, json]
.*3. View Route*
----
{
  "creationTimestamp": "2023-05-02T19:24:42.138-07:00",
  "description": "",
  "destRange": "10.2.1.0/24",
  "id": "2320179531580472069",
  "kind": "compute#route",
  "name": "on-prem-tunnel-route-2",
  "network": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/global/networks/on-prem",
  "nextHopVpnTunnel": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/vpnTunnels/on-prem-tunnel",
  "priority": 1000,
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/global/routes/on-prem-tunnel-route-2"
}
----

== Test Hybrid Connectivity

=== View Gateway

[source, json]
.*vpc-demo-gw*
----
{
  "creationTimestamp": "2023-05-02T19:04:56.135-07:00",
  "description": "",
  "forwardingRules": [
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/forwardingRules/vpc-demo-gw-rule-udp4500",
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/forwardingRules/vpc-demo-gw-rule-esp",
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/forwardingRules/vpc-demo-gw-rule-udp500"
  ],
  "id": "8775027787011227559",
  "kind": "compute#targetVpnGateway",
  "labelFingerprint": "42WmSpB8rSM=",
  "name": "vpc-demo-gw",
  "network": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/global/networks/vpc-demo",
  "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1",
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/targetVpnGateways/vpc-demo-gw",
  "status": "READY",
  "tunnels": [
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/vpnTunnels/vpc-demo-tunnel"
  ]
}
----

[source, json]
.*on-prem-gw*
----
{
  "creationTimestamp": "2023-05-02T19:20:23.735-07:00",
  "description": "",
  "forwardingRules": [
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/forwardingRules/on-prem-gw-rule-udp4500",
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/forwardingRules/on-prem-gw-rule-esp",
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/forwardingRules/on-prem-gw-rule-udp500"
  ],
  "id": "57958731370756616",
  "kind": "compute#targetVpnGateway",
  "labelFingerprint": "42WmSpB8rSM=",
  "name": "on-prem-gw",
  "network": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/global/networks/on-prem",
  "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1",
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/targetVpnGateways/on-prem-gw",
  "status": "READY",
  "tunnels": [
    "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/vpnTunnels/on-prem-tunnel"
  ]
}
----

=== View Tunnel

[source, json]
.*vpc-demo-tunnel*
----
{
  "creationTimestamp": "2023-05-02T19:09:26.146-07:00",
  "description": "",
  "detailedStatus": "Tunnel is up and running.",
  "id": "4107248168553184441",
  "ikeVersion": 2,
  "kind": "compute#vpnTunnel",
  "labelFingerprint": "42WmSpB8rSM=",
  "localTrafficSelector": [
    "10.2.1.0/24",
    "10.1.1.0/24"
  ],
  "name": "vpc-demo-tunnel",
  "peerIp": "35.226.19.45",
  "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1",
  "remoteTrafficSelector": [
    "192.168.1.0/24"
  ],
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/vpnTunnels/vpc-demo-tunnel",
  "sharedSecret": "*************",
  "sharedSecretHash": "Ia4pAN2LTlSgnXNLXPBMVojwjnYn",
  "status": "ESTABLISHED",
  "targetVpnGateway": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-east1/targetVpnGateways/vpc-demo-gw"
}
----

[source, json]
.*on-prem-tunnel*
----
{
  "creationTimestamp": "2023-05-02T19:22:26.834-07:00",
  "description": "",
  "detailedStatus": "Tunnel is up and running.",
  "id": "8007397653815786381",
  "ikeVersion": 2,
  "kind": "compute#vpnTunnel",
  "labelFingerprint": "42WmSpB8rSM=",
  "localTrafficSelector": [
    "192.168.1.0/24"
  ],
  "name": "on-prem-tunnel",
  "peerIp": "34.139.16.101",
  "region": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1",
  "remoteTrafficSelector": [
    "10.1.1.0/24",
    "10.2.1.0/24"
  ],
  "selfLink": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/vpnTunnels/on-prem-tunnel",
  "sharedSecret": "*************",
  "sharedSecretHash": "OlUjBQaZA2WpwN_Ho5GhKA5kA-jf",
  "status": "ESTABLISHED",
  "targetVpnGateway": "https://www.googleapis.com/compute/v1/projects/playground-s-11-c08fdfcc/regions/us-central1/targetVpnGateways/on-prem-gw"
}
----

=== Test Connectivity via ICMP

[source, bash]
.*1. VPC VM ping On PREM VM*
----
$ ping 192.168.1.2 -c3
PING 192.168.1.2 (192.168.1.2) 56(84) bytes of data.
64 bytes from 192.168.1.2: icmp_seq=1 ttl=62 time=68.5 ms
64 bytes from 192.168.1.2: icmp_seq=2 ttl=62 time=63.7 ms
64 bytes from 192.168.1.2: icmp_seq=3 ttl=62 time=63.6 ms
----

[source, bash]
.*2. On PREM VM ping VPC VM*
----
$ ping 10.1.1.2 -c3
PING 10.1.1.2 (10.1.1.2) 56(84) bytes of data.
64 bytes from 10.1.1.2: icmp_seq=1 ttl=62 time=68.7 ms
64 bytes from 10.1.1.2: icmp_seq=2 ttl=62 time=63.8 ms
64 bytes from 10.1.1.2: icmp_seq=3 ttl=62 time=63.7 ms

$ ping 10.2.1.2 -c3
PING 10.2.1.2 (10.2.1.2) 56(84) bytes of data.
64 bytes from 10.2.1.2: icmp_seq=1 ttl=62 time=36.5 ms
64 bytes from 10.2.1.2: icmp_seq=2 ttl=62 time=31.9 ms
64 bytes from 10.2.1.2: icmp_seq=3 ttl=62 time=32.0 ms
----

=== Clean up

[source, bash]
----
gcloud compute routes delete on-prem-tunnel-route-2
gcloud compute routes delete on-prem-tunnel-route-1
gcloud compute vpn-tunnels delete on-prem-tunnel --region=us-central1
gcloud compute forwarding-rules delete on-prem-gw-rule-udp4500 --region=us-central1
gcloud compute forwarding-rules delete on-prem-gw-rule-udp500 --region=us-central1
gcloud compute forwarding-rules delete on-prem-gw-rule-esp --region=us-central1
gcloud compute target-vpn-gateways delete on-prem-gw --region=us-central1

gcloud compute routes delete vpc-demo-tunnel-route-1
gcloud compute vpn-tunnels delete vpc-demo-tunnel --region=us-east1
gcloud compute forwarding-rules delete vpc-demo-gw-rule-udp4500 --region=us-east1
gcloud compute forwarding-rules delete vpc-demo-gw-rule-udp500 --region=us-east1
gcloud compute forwarding-rules delete vpc-demo-gw-rule-esp --region=us-east1
gcloud compute target-vpn-gateways delete vpc-demo-gw --region=us-east1

gcloud compute addresses delete on-prem-gw-ip --region=us-central1
gcloud compute addresses delete vpc-demo-gw-ip --region=us-east1
----

