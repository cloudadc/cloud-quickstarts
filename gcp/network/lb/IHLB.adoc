= Internal HTTP load balancer
:toc: manual

== Topologies

image:img/e.png[]

=== Prepare the Network

[source, bash]
.*1. create internal network and subnets*
----
gcloud compute networks create internal --subnet-mode=custom
gcloud compute networks subnets create internal-a --network=internal --range=10.10.10.0/24 --region=us-central1
gcloud compute networks subnets create internal-b --network=internal --range=10.10.20.0/24 --region=us-central1
gcloud compute networks subnets create internal-lb --network=internal --range=10.10.30.0/24 --region=us-central1
gcloud compute networks subnets create internal-proxy --purpose=REGIONAL_MANAGED_PROXY --role=ACTIVE --network=internal --range=10.10.40.0/24 --region=us-central1
----

[source, bash]
.*2. create firewall rule allow icmp, ssh from any source*
----
gcloud compute firewall-rules create app-allow-icmp-ssh --direction=INGRESS --priority=1000 --network=internal --action=ALLOW --rules=tcp:22,icmp --source-ranges=0.0.0.0/0 --target-tags=backend-service
----

[source, bash]
.*3. create firewall rule allow IAP to utility VM*
----
gcloud compute firewall-rules create allow-iap-to-utility-vm --direction=INGRESS --priority=1000 --network=internal --action=ALLOW --rules=tcp:22,icmp --source-ranges=35.235.240.0/20 --target-tags=utility-vm
----

[source, bash]
.*4. create firewall rule allow application internal access*
----
gcloud compute firewall-rules create allow-app-access-from-internal --direction=INGRESS --priority=1000 --network=internal --action=ALLOW --rules=tcp:8080 --source-ranges=10.10.10.0/24,10.10.20.0/24,10.10.30.0/24,10.10.40.0/24 --target-tags=backend-service
----

[source, bash]
.*5. create firewall rule allow health check*
----
gcloud compute firewall-rules create allow-health-checks --direction=INGRESS --priority=1000 --network=internal --action=ALLOW --rules=tcp:8080 --source-ranges=130.211.0.0/22,35.191.0.0/16 --target-tags=backend-service
----

=== Prepare application image

[source, bash]
.*1. Create VM Instance*
----
gcloud compute instances create webserver \
   --zone=us-central1-a \
   --machine-type=e2-micro \
   --network-interface=network-tier=PREMIUM,subnet=internal-a \
   --tags=backend-service \
   --create-disk=auto-delete=no,boot=yes,device-name=webserver,image=projects/debian-cloud/global/images/debian-11-bullseye-v20230306,mode=rw,size=10,type=pd-balanced \
   --metadata=startup-script='#!/bin/bash
      apt-get update
      apt-get install -y nginx
      curl -k -s https://raw.githubusercontent.com/cloudadc/cloud-quickstarts/main/gcp/network/lb/app.conf -o /etc/nginx/conf.d/app.conf
      update-rc.d nginx enable
      service nginx restart'
----

* `--tags` - the `allow-health-checks` hints the firewall rules will filter traffic via tag `allow-health-checks`
* `--create-disk` - the `webserver` is the name of Disk, the `auto-delete=no` means Disk will keep even the Instance be deleted

[source, bash]
.*2. Delete the VM Instance*
----
gcloud compute instances delete webserver --zone=us-central1-a
----

[source, bash]
.*3. Verify the Disk Still Exist*
----
$ gcloud compute disks list
NAME: webserver
LOCATION: us-central1-a
LOCATION_SCOPE: zone
SIZE_GB: 10
TYPE: pd-balanced
STATUS: READY
----

[source, bash]
.*4. Create VM Image*
----
gcloud compute images create testwebserver --source-disk=webserver --source-disk-zone=us-central1-a --storage-location=us --family=webserver
----

== Backend Applications

=== Create instance group app-v1

[source, bash]
.*1. create instance template*
----
gcloud compute instance-templates create app-v1 --machine-type=e2-micro --network-interface=subnet=internal-a,no-address --region=us-central1 --tags=backend-service --create-disk=auto-delete=yes,boot=yes,device-name=app-v1,image=testwebserver,mode=rw,size=10,type=pd-balanced
----

[source, bash]
.*2. create instance groups*
----
gcloud compute instance-groups managed create ig-app-v1 --base-instance-name=app-v1 --size=2 --template=app-v1 --region=us-central1 --list-managed-instances-results=pageless
----

[source, bash]
.*3. set named ports*
----
gcloud compute instance-groups managed set-named-ports ig-app-v1 --named-ports=webapp:8080 --region=us-central1
----

=== Create instance group app-v2

[source, bash]
.*1. create instance template*
----
gcloud compute instance-templates create app-v2 --machine-type=e2-micro --network-interface=subnet=internal-b,no-address --region=us-central1 --tags=backend-service --create-disk=auto-delete=yes,boot=yes,device-name=app-v2,image=testwebserver,mode=rw,size=10,type=pd-balanced
----

[source, bash]
.*2. create instance groups*
----
gcloud compute instance-groups managed create ig-app-v2 --base-instance-name=app-v2 --size=2 --template=app-v2 --region=us-central1 --list-managed-instances-results=pageless
----

[source, bash]
.*3. set named ports*
----
gcloud compute instance-groups managed set-named-ports ig-app-v2 --named-ports=webapp:8080 --region=us-central1
----

=== Crate utility vm test backend services

[source, bash]
.*1. create utility vm*
----
gcloud compute instances create utility-vm \
    --zone=us-central1-c \
    --tags=utility-vm \
    --machine-type=e2-micro \
    --image-family=debian-11 \
    --image-project=debian-cloud \
    --network-interface=private-network-ip=10.10.10.50,subnet=internal-a,no-address
----

[source, bash]
.*2. ssh to utility vm*
----
gcloud compute ssh utility-vm --zone=us-central1-c --tunnel-through-iap
----

[source, bash]
.*3. access application in blue instance group*
----
utility-vm:~$ curl 10.10.10.7:8080/blue

            request: GET /blue HTTP/1.1
               host: 10.10.10.7
           hostname: blue-n7gm

        client addr: 10.10.10.50:48216
        server addr: 10.10.10.7:8080

utility-vm:~$ curl 10.10.10.8:8080/blue

            request: GET /blue HTTP/1.1
               host: 10.10.10.8
           hostname: blue-qkf4

        client addr: 10.10.10.50:34012
        server addr: 10.10.10.8:8080
----

[source, bash]
.*4. access application in green instance group*
----
utility-vm:~$ curl 10.10.20.4:8080/green

            request: GET /green HTTP/1.1
               host: 10.10.20.4
           hostname: green-s7qr

        client addr: 10.10.10.50:34334
        server addr: 10.10.20.4:8080

utility-vm:~$ curl 10.10.20.5:8080/green

            request: GET /green HTTP/1.1
               host: 10.10.20.5
           hostname: green-gpmg

        client addr: 10.10.10.50:52178
        server addr: 10.10.20.5:8080
----

== Basic Load Balancer Configuration

=== Create HTTP health check

[source, bash]
----
gcloud compute health-checks create http http-heatlh-check --region=us-central1 --port=8080 --check-interval=10 --timeout=5 --healthy-threshold=2 --unhealthy-threshold=3
----

=== Create Backends

==== Create `app-v1-service` with managed instance group `ig-app-v1`

[source, bash]
.*1. create internal backend service*
----
gcloud compute backend-services create app-v1-service --load-balancing-scheme=INTERNAL_MANAGED --protocol=HTTP --port-name=webapp --health-checks=http-heatlh-check --health-checks-region=us-central1 --region=us-central1
----

[source, bash]
.*2. add instance groups to backend service*
----
gcloud compute backend-services add-backend app-v1-service --region=us-central1 --instance-group=ig-app-v1 --instance-group-region=us-central1 --balancing-mode=UTILIZATION --max-utilization=0.8 --capacity-scaler=1.0 
----

==== Create `app-v2-service` with managed instance group `ig-app-v2`

[source, bash]
.*1. create internal backend service*
----
gcloud compute backend-services create app-v2-service --load-balancing-scheme=INTERNAL_MANAGED --protocol=HTTP --port-name=webapp --health-checks=http-heatlh-check --health-checks-region=us-central1 --region=us-central1
----

[source, bash]
.*2. add instance groups to backend service*
----
gcloud compute backend-services add-backend app-v2-service --region=us-central1 --instance-group=ig-app-v2 --instance-group-region=us-central1 --balancing-mode=UTILIZATION --max-utilization=0.8 --capacity-scaler=1.0 
----

=== Create URL Maps

[source, bash]
----
gcloud compute url-maps create l7-ihlb-map --default-service=app-v1-service --region=us-central1
----

=== Create Target Proxy

[source, bash]
----
gcloud compute target-http-proxies create l7-ihlb-proxy --url-map=l7-ihlb-map --url-map-region=us-central1 --region=us-central1
----

=== Create Forwarding Rule

[source, bash]
----
gcloud compute forwarding-rules create l7-ihlb-forwarding-rule --load-balancing-scheme=INTERNAL_MANAGED --target-http-proxy=l7-ihlb-proxy  --target-http-proxy-region=us-central1 --network=internal --subnet=internal-lb --address=10.10.30.11 --ports=80 --region=us-central1
----

=== Test Basic Load Balancer

[source, bash]
.*1. ssh to utility vm*
----
gcloud compute ssh utility-vm --zone=us-central1-c --tunnel-through-iap
----

[source, bash]
.*2. access app via LB IP*
----
utility-vm:~$ curl 10.10.30.11

            request: GET / HTTP/1.1
               host: 10.10.30.11
           hostname: app-v1-7kwg

        client addr: 10.10.40.5:54286
        server addr: 10.10.10.5:8080

utility-vm:~$ curl 10.10.30.11

            request: GET / HTTP/1.1
               host: 10.10.30.11
           hostname: app-v1-zbvh

        client addr: 10.10.40.2:47208
        server addr: 10.10.10.6:8080
----






== TD

=== Set up traffic management(blue/green)

[source, bash]
.*1. create ihlb-bule-green.yaml content as the following*
----
name: ihlb-bule-green
defaultService: regions/us-central1/backendServices/green-service
hostRules:
- hosts:
  - '*'
  pathMatcher: matcher1
pathMatchers:
- defaultService: regions/us-central1/backendServices/green-service
  name: matcher1
  routeRules:
  - priority: 2
    matchRules:
      - prefixMatch: /
    routeAction:
      weightedBackendServices:
        - backendService: regions/us-central1/backendServices/green-service
          weight: 95
        - backendService: regions/us-central1/backendServices/blue-service
          weight: 5
----

[source, bash]
.*2. Create the URL map*
----
gcloud compute url-maps import ihlb-bule-green --region=us-central1 --source=ihlb-bule-green.yaml
----

=== Setting up an HTTP frontend(blue/green)

[source, bash]
.*1. Create a target HTTP proxy to route requests to blue/green URL map*
----
gcloud compute target-http-proxies create ihlb-thp-bule-green --url-map=ihlb-bule-green --url-map-region=us-central1 --region=us-central1
----

[source, bash]
.*2. Create forwarding rules reference with blue/green http proxy*
----
gcloud compute forwarding-rules create ihlb-fr-blue-green --load-balancing-scheme=INTERNAL_MANAGED --target-http-proxy=ihlb-thp-bule-green --target-http-proxy-region=us-central1 --network=internal --subnet=internal-lb --address=10.10.30.5 --ports=80 --region=us-central1
----

=== Test blue/green access

[source, bash]
.*1. Access the application several times, count the blue/green rate*
----
$ for i in {1..1000} ; do curl -s http://10.10.30.5 | grep hostname ; done > out

$ cat out | wc -l
1000

$ cat out | grep blue | wc -l
48

$ cat out | grep green | wc -l
952
----

[source, bash]
.*2. Access the application several times, review snat address*
----
$ for i in {1..10} ; do curl -s http://10.10.30.5 | grep client ; done
        client addr: 10.10.40.3:42582
        client addr: 10.10.40.3:38666
        client addr: 10.10.40.3:42582
        client addr: 10.10.40.2:51752
        client addr: 10.10.40.4:50638
        client addr: 10.10.40.4:51336
        client addr: 10.10.40.3:38666
        client addr: 10.10.40.4:50638
        client addr: 10.10.40.2:52810
        client addr: 10.10.40.5:55542
----

=== Blue/green Packet Flow Deep Dive 

This section will install tcpdump on both ig-green and ig-blue's vm, capture the packet flow, due to the vm are internal, to install tcpdump need set up nat firstly.

[source, bash]
.*1. create cloud router*
----
gcloud compute routers create nat-router-us-central1 --region=us-central1 --network=internal --advertisement-mode=CUSTOM --set-advertisement-ranges=10.10.10.0/24,10.10.20.0/24
----

[source, bash]
.*2. create cloud nat*
----
gcloud compute routers nats create nat-us-central1 --router=nat-router-us-central1 --router-region=us-central1 --auto-allocate-nat-external-ips --nat-custom-subnet-ip-ranges=internal-a,internal-b
----

[source, bash]
.*3. install tcpdump either on ig-blue vm, or ig-green vm*
----
sudo apt-get install tcpdump -y
----

[source, bash]
.*4 Capture the health check packet*
----
$ sudo tcpdump -nni ens4 port 8080
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on ens4, link-type EN10MB (Ethernet), snapshot length 262144 bytes
09:18:38.900556 IP 35.191.8.79.35284 > 10.10.10.7.8080: Flags [S], seq 2155631061, win 65535, options [mss 1420,sackOK,TS val 3285289368 ecr 0,nop,wscale 8], length 0
09:18:38.900594 IP 10.10.10.7.8080 > 35.191.8.79.35284: Flags [S.], seq 4250585293, ack 2155631062, win 64768, options [mss 1420,sackOK,TS val 3375367435 ecr 3285289368,nop,wscale 7], length 0
09:18:38.901453 IP 35.191.8.79.35284 > 10.10.10.7.8080: Flags [P.], seq 1:87, ack 1, win 256, options [nop,nop,TS val 3285289371 ecr 3375367435], length 86: HTTP: GET / HTTP/1.1
09:18:38.901456 IP 35.191.8.79.35284 > 10.10.10.7.8080: Flags [.], ack 1, win 256, options [nop,nop,TS val 3285289370 ecr 3375367435], length 0
----

NOTE: The `35.191.8.79` from health check snat address.

[source, bash]
.*5. Capture the traffic from LB*
----
09:21:10.697309 IP 10.10.40.4.43810 > 10.10.10.7.8080: Flags [P.], seq 629:786, ack 1649, win 273, options [nop,nop,TS val 1574104694 ecr 2605581615], length 157: HTTP: GET / HTTP/1.1
09:21:10.697534 IP 10.10.10.7.8080 > 10.10.40.4.43810: Flags [P.], seq 1649:2061, ack 786, win 501, options [nop,nop,TS val 2605583184 ecr 1574104694], length 412: HTTP: HTTP/1.1 200 OK
----

NOTE: The `10.10.40.4` from Envoy based MANAGED internal HTTP Load balancing snat address.

=== Set up traffic management(url map)

[source, bash]
.*1. create ihlb-path-map.yaml content as the following*
----
name: ihlb-pathmap
defaultService: regions/us-central1/backendServices/green-service
hostRules:
- hosts:
  - '*'
  pathMatcher: pathmap
pathMatchers:
- defaultService: regions/us-central1/backendServices/green-service
  name: pathmap
  - paths:
    - /blue
    - /blue/*
    service: regions/us-central1/backendServices/blue-service
----

[source, bash]
.*2. Create the URL map*
----
gcloud compute url-maps import ihlb-path-map --region=us-central1 --source=ihlb-path-map.yaml
----

=== Setting up an HTTP frontend(path map)

[source, bash]
.*1. Create a target HTTP proxy to route requests to path map URL map*
----
gcloud compute target-http-proxies create ihlb-thp-path-map --url-map=ihlb-path-map --url-map-region=us-central1 --region=us-central1
----

[source, bash]
.*2. Create forwarding rules reference with path map http proxy*
----
gcloud compute forwarding-rules create ihlb-fr-path-map --load-balancing-scheme=INTERNAL_MANAGED --target-http-proxy=ihlb-thp-path-map --target-http-proxy-region=us-central1 --network=internal --subnet=internal-lb --address=10.10.30.6 --ports=80 --region=us-central1
----

=== Test url map access

[source, bash]
.*1. access with url /blue/test*
----
$ curl http://10.10.30.6/blue/test

            request: GET /blue/test HTTP/1.1
               host: 10.10.30.6
           hostname: blue-qkf4

        client addr: 10.10.40.5:41970
        server addr: 10.10.10.8:8080

             cookie:
                xff:
         user agent: curl/7.74.0
----

[source, bash]
.*2. access with url /green/test*
----
$ curl http://10.10.30.6/green/test

            request: GET /green/test HTTP/1.1
               host: 10.10.30.6
           hostname: green-s7qr

        client addr: 10.10.40.5:38630
        server addr: 10.10.20.4:8080

             cookie:
                xff:
         user agent: curl/7.74.0
----


